<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
        h1, h2 { text-align: center; color: #333; }
        .nav-menu { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .nav-menu button { padding: 10px 15px; background-color: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .nav-menu button:hover { background-color: #0056b3; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; }
        .button { padding: 10px 20px; background-color: #28a745; color: white; border: none; cursor: pointer; border-radius: 4px; }
        .button:hover { background-color: #218838; }
        .message { margin-top: 20px; text-align: center; font-weight: bold; }
        .message.success { color: green; }
        .message.error { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Portal</h1>
        <div class="nav-menu">
            <button onclick="showSection('create-user')">Create User</button>
            <button onclick="showSection('schedule-class')">Schedule Class</button>
            <button onclick="showSection('upload-result')">Upload Result</button>
            <button onclick="showSection('manage-subjects')">Manage Subjects</button>
        </div>

        <div id="create-user" class="content-section active">
            <h2>Create New User</h2>
            <form id="create-user-form">
                <div class="form-group">
                    <label for="user_type">User Type:</label>
                    <select name="user_type" id="user_type" required>
                        <option value="admin">Admin</option>
                        <option value="teacher">Teacher</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button class="button" type="submit">Create User</button>
            </form>
            <p id="create-user-message" class="message"></p>
        </div>

        <div id="schedule-class" class="content-section">
            <h2>Schedule a New Class</h2>
            <form id="schedule-class-form">
                <div class="form-group">
                    <label for="class_id">Class:</label>
                    <select name="class_id" id="class_id" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="subject_id">Subject:</label>
                    <select name="subject_id" id="subject_id" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="teacher_id">Teacher:</label>
                    <select name="teacher_id" id="teacher_id" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="day_of_week">Day of Week:</label>
                    <select name="day_of_week" id="day_of_week" required>
                        <option value="Monday">Monday</option>
                        <option value="Tuesday">Tuesday</option>
                        <option value="Wednesday">Wednesday</option>
                        <option value="Thursday">Thursday</option>
                        <option value="Friday">Friday</option>
                        <option value="Saturday">Saturday</option>
                        <option value="Sunday">Sunday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="start_time">Start Time:</label>
                    <input type="time" id="start_time" name="start_time" required>
                </div>
                <div class="form-group">
                    <label for="end_time">End Time:</label>
                    <input type="time" id="end_time" name="end_time" required>
                </div>
                <button class="button" type="submit">Schedule Class</button>
            </form>
            <p id="schedule-class-message" class="message"></p>
        </div>

        <div id="upload-result" class="content-section">
            <h2>Upload Student Result</h2>
            <form id="upload-result-form">
                <div class="form-group">
                    <label for="student_id">Student:</label>
                    <select name="student_id" id="student_id" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="subject_id_result">Subject:</label>
                    <select name="subject_id" id="subject_id_result" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="score">Score:</label>
                    <input type="number" step="0.01" id="score" name="score" required>
                </div>
                <div class="form-group">
                    <label for="term">Term:</label>
                    <input type="text" id="term" name="term" required>
                </div>
                <button class="button" type="submit">Upload Result</button>
            </form>
            <p id="upload-result-message" class="message"></p>
        </div>

        <div id="manage-subjects" class="content-section">
            <h2>Manage Subjects</h2>
            
            <h3>Add New Subject</h3>
            <form id="add-subject-form">
                <input type="hidden" name="action" value="add">
                <div class="form-group">
                    <label for="subject_name">Subject Name:</label>
                    <input type="text" id="subject_name" name="subject_name" required>
                </div>
                <button class="button" type="submit">Add Subject</button>
            </form>

            <hr>

            <h3>Existing Subjects</h3>
            <ul id="subjects-list">
                </ul>
            <p id="manage-subjects-message" class="message"></p>
        </div>
    </div>

    <script>
        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            // Populate select dropdowns when a section is activated
            if (sectionId === 'schedule-class') {
                populateDropdowns('classes', 'class_id');
                populateDropdowns('subjects', 'subject_id');
                populateDropdowns('teachers', 'teacher_id');
            } else if (sectionId === 'upload-result') {
                populateDropdowns('students', 'student_id');
                populateDropdowns('subjects', 'subject_id_result');
            } else if (sectionId === 'manage-subjects') {
                fetchSubjects();
            }
        }

        async function populateDropdowns(endpoint, selectId) {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = ''; // Clear existing options

            const response = await fetch(`/${endpoint}`);
            const data = await response.json();
            
            if (data.success) {
                data.data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.name;
                    selectElement.appendChild(option);
                });
            } else {
                console.error(`Failed to fetch ${endpoint}:`, data.message);
            }
        }

        async function handleFormSubmit(event, endpoint, messageId) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            const messageElement = document.getElementById(messageId);
            messageElement.textContent = 'Processing...';
            messageElement.className = 'message';

            try {
                const response = await fetch(`/${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });
                const result = await response.json();
                
                if (result.success) {
                    messageElement.textContent = result.message;
                    messageElement.classList.add('success');
                    form.reset();
                    // Re-fetch subjects after adding/removing one
                    if (endpoint === 'manage_subjects') {
                        fetchSubjects();
                    }
                } else {
                    messageElement.textContent = result.message;
                    messageElement.classList.add('error');
                }
            } catch (error) {
                messageElement.textContent = 'An unexpected error occurred.';
                messageElement.classList.add('error');
                console.error('Error:', error);
            }
        }

        async function fetchSubjects() {
            const subjectsList = document.getElementById('subjects-list');
            subjectsList.innerHTML = '';
            const messageElement = document.getElementById('manage-subjects-message');
            messageElement.textContent = '';

            try {
                const response = await fetch('/subjects');
                const data = await response.json();

                if (data.success) {
                    if (data.data.length > 0) {
                        data.data.forEach(subject => {
                            const li = document.createElement('li');
                            li.innerHTML = `
                                <span>${subject.name}</span>
                                <form onsubmit="handleFormSubmit(event, 'manage_subjects', 'manage-subjects-message')">
                                    <input type="hidden" name="action" value="remove">
                                    <input type="hidden" name="subject_id" value="${subject.id}">
                                    <button class="remove-btn" type="submit">Remove</button>
                                </form>
                            `;
                            subjectsList.appendChild(li);
                        });
                    } else {
                        subjectsList.innerHTML = '<li>No subjects found.</li>';
                    }
                } else {
                    messageElement.textContent = data.message;
                    messageElement.classList.add('error');
                }
            } catch (error) {
                messageElement.textContent = 'An error occurred while fetching subjects.';
                messageElement.classList.add('error');
                console.error('Error:', error);
            }
        }

        document.getElementById('create-user-form').addEventListener('submit', (e) => handleFormSubmit(e, 'create_user', 'create-user-message'));
        document.getElementById('schedule-class-form').addEventListener('submit', (e) => handleFormSubmit(e, 'schedule_class', 'schedule-class-message'));
        document.getElementById('upload-result-form').addEventListener('submit', (e) => handleFormSubmit(e, 'upload_result', 'upload-result-message'));
        document.getElementById('add-subject-form').addEventListener('submit', (e) => handleFormSubmit(e, 'manage_subjects', 'manage-subjects-message'));

        // Initialize the first section
        document.addEventListener('DOMContentLoaded', () => {
            showSection('create-user');
        });
    </script>
</body>
</html>